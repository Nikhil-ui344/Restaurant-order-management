{% extends 'base.html' %}

{% block title %}Analytics Dashboard{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/analytics.css') }}">
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Background decorations -->
    <div class="analytics-background-decorations">
        <img src="{{ url_for('static', filename='images/leaf.svg') }}" class="floating-decoration leaf-1" alt="">
        <img src="{{ url_for('static', filename='images/circle.svg') }}" class="floating-decoration circle-1" alt="">
        <img src="{{ url_for('static', filename='images/mint.svg') }}" class="floating-decoration mint-1" alt="">
    </div>

    <header class="analytics-header glass-header fade-in-down">
        <div class="header-content">
            <div class="analytics-title">
                <img src="{{ url_for('static', filename='images/home.svg') }}" class="analytics-icon pulse" alt="Analytics">
                <h1>üìä Business Analytics</h1>
            </div>
            <div class="header-actions">
                <button onclick="refreshData()" class="btn btn-secondary refresh-btn" title="Refresh Data">
                    <span>üîÑ</span>
                    <span>Refresh</span>
                </button>
                <a href="{{ url_for('admin_panel') }}" class="btn btn-primary">
                    <span>‚Üê Back to Admin</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Analytics Navigation -->
    <nav class="analytics-nav fade-in-up" style="animation-delay: 0.1s;">
        <div class="nav-container">
            <button class="nav-btn active" onclick="switchView('overview')" data-view="overview">
                <span class="nav-icon">üìà</span>
                <span>Overview</span>
            </button>
            <button class="nav-btn" onclick="switchView('daily')" data-view="daily">
                <span class="nav-icon">üìÖ</span>
                <span>Daily Sales</span>
            </button>
            <button class="nav-btn" onclick="switchView('weekly')" data-view="weekly">
                <span class="nav-icon">üìä</span>
                <span>Weekly Sales</span>
            </button>
            <button class="nav-btn" onclick="switchView('monthly')" data-view="monthly">
                <span class="nav-icon">üìÜ</span>
                <span>Monthly Sales</span>
            </button>
            <button class="nav-btn" onclick="switchView('popular')" data-view="popular">
                <span class="nav-icon">‚≠ê</span>
                <span>Popular Items</span>
            </button>
        </div>
    </nav>

    <!-- Overview Section -->
    <section id="overview-section" class="analytics-section active">
        <div class="section-header">
            <h2>Business Overview</h2>
            <p>Complete analytics from your restaurant database</p>
        </div>
        
        <div class="overview-grid fade-in-up" style="animation-delay: 0.2s;">
            <div class="metric-card glass-card">
                <div class="metric-icon">üí∞</div>
                <div class="metric-content">
                    <h3>Total Revenue</h3>
                    <p class="metric-value" id="total-revenue">‚Çπ0</p>
                    <span class="metric-label">All time</span>
                </div>
            </div>
            
            <div class="metric-card glass-card">
                <div class="metric-icon">üì¶</div>
                <div class="metric-content">
                    <h3>Total Orders</h3>
                    <p class="metric-value" id="total-orders">0</p>
                    <span class="metric-label">Completed orders</span>
                </div>
            </div>
            
            <div class="metric-card glass-card">
                <div class="metric-icon">üìä</div>
                <div class="metric-content">
                    <h3>Average Order</h3>
                    <p class="metric-value" id="avg-order">‚Çπ0</p>
                    <span class="metric-label">Per order value</span>
                </div>
            </div>
            
            <div class="metric-card glass-card">
                <div class="metric-icon">üèÜ</div>
                <div class="metric-content">
                    <h3>Top Category</h3>
                    <p class="metric-value" id="top-category">-</p>
                    <span class="metric-label">Most popular</span>
                </div>
            </div>
        </div>

        <div class="charts-row fade-in-up" style="animation-delay: 0.3s;">
            <div class="chart-card glass-card">
                <div class="chart-header">
                    <h3>Revenue Trend (Last 7 Days)</h3>
                </div>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card glass-card">
                <div class="chart-header">
                    <h3>Category Distribution</h3>
                </div>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Daily Sales Section -->
    <section id="daily-section" class="analytics-section">
        <div class="section-header">
            <h2>Daily Sales Analysis</h2>
            <p>Day-by-day performance breakdown</p>
        </div>
        
        <div class="chart-card glass-card large-chart fade-in-up" style="animation-delay: 0.2s;">
            <div class="chart-header">
                <h3>Daily Revenue & Orders (Last 30 Days)</h3>
            </div>
            <div class="chart-container">
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
        
        <div class="daily-stats fade-in-up" style="animation-delay: 0.3s;">
            <div class="stat-card glass-card">
                <h4>Today's Sales</h4>
                <p id="today-sales">‚Çπ0</p>
            </div>
            <div class="stat-card glass-card">
                <h4>Yesterday's Sales</h4>
                <p id="yesterday-sales">‚Çπ0</p>
            </div>
            <div class="stat-card glass-card">
                <h4>Best Day (Last 30)</h4>
                <p id="best-day">‚Çπ0</p>
            </div>
            <div class="stat-card glass-card">
                <h4>Average Daily</h4>
                <p id="avg-daily">‚Çπ0</p>
            </div>
        </div>
    </section>

    <!-- Weekly Sales Section -->
    <section id="weekly-section" class="analytics-section">
        <div class="section-header">
            <h2>Weekly Sales Analysis</h2>
            <p>Week-by-week performance trends</p>
        </div>
        
        <div class="chart-card glass-card large-chart fade-in-up" style="animation-delay: 0.2s;">
            <div class="chart-header">
                <h3>Weekly Revenue Trends</h3>
            </div>
            <div class="chart-container">
                <canvas id="weeklyChart"></canvas>
            </div>
        </div>
    </section>

    <!-- Monthly Sales Section -->
    <section id="monthly-section" class="analytics-section">
        <div class="section-header">
            <h2>Monthly Sales Analysis</h2>
            <p>Month-by-month business growth</p>
        </div>
        
        <div class="chart-card glass-card large-chart fade-in-up" style="animation-delay: 0.2s;">
            <div class="chart-header">
                <h3>Monthly Revenue Growth</h3>
            </div>
            <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
    </section>

    <!-- Popular Items Section -->
    <section id="popular-section" class="analytics-section">
        <div class="section-header">
            <h2>Popular Items Analysis</h2>
            <p>Top performing menu items and categories</p>
        </div>
        
        <div class="popular-grid fade-in-up" style="animation-delay: 0.2s;">
            <div class="chart-card glass-card">
                <div class="chart-header">
                    <h3>Top 10 Items</h3>
                </div>
                <div class="chart-container">
                    <canvas id="popularItemsChart"></canvas>
                </div>
            </div>
            
            <div class="popular-list-card glass-card">
                <div class="chart-header">
                    <h3>Detailed Rankings</h3>
                </div>
                <div class="popular-items-list" id="popular-items-list">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p>Loading analytics data...</p>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart instances
let charts = {};

// Initialize analytics page
document.addEventListener('DOMContentLoaded', function() {
    loadOverviewData();
    initializeAnimations();
});

// Navigation functionality
function switchView(view) {
    // Update navigation
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[data-view="${view}"]`).classList.add('active');
    
    // Update sections
    document.querySelectorAll('.analytics-section').forEach(section => section.classList.remove('active'));
    document.getElementById(`${view}-section`).classList.add('active');
    
    // Load specific data
    switch(view) {
        case 'overview':
            loadOverviewData();
            break;
        case 'daily':
            loadDailyData();
            break;
        case 'weekly':
            loadWeeklyData();
            break;
        case 'monthly':
            loadMonthlyData();
            break;
        case 'popular':
            loadPopularData();
            break;
    }
}

// Load overview data
async function loadOverviewData() {
    showLoading();
    try {
        const response = await fetch('/api/analytics/overview');
        const data = await response.json();
        
        // Update metrics
        document.getElementById('total-revenue').textContent = `‚Çπ${data.totalRevenue.toFixed(2)}`;
        document.getElementById('total-orders').textContent = data.totalOrders;
        document.getElementById('avg-order').textContent = `‚Çπ${data.avgOrder.toFixed(2)}`;
        document.getElementById('top-category').textContent = data.topCategory;
        
        // Load charts
        loadRevenueChart(data.revenueData);
        loadCategoryChart(data.categoryData);
        
    } catch (error) {
        console.error('Error loading overview data:', error);
    } finally {
        hideLoading();
    }
}

// Load daily data
async function loadDailyData() {
    showLoading();
    try {
        const response = await fetch('/api/analytics/daily');
        const data = await response.json();
        
        // Calculate stats from the data
        const todaySales = data.revenue[data.revenue.length - 1] || 0;
        const yesterdaySales = data.revenue[data.revenue.length - 2] || 0;
        const bestDay = Math.max(...data.revenue);
        const avgDaily = data.total_revenue / data.revenue.length || 0;
        
        // Update daily stats
        document.getElementById('today-sales').textContent = `‚Çπ${todaySales.toFixed(2)}`;
        document.getElementById('yesterday-sales').textContent = `‚Çπ${yesterdaySales.toFixed(2)}`;
        document.getElementById('best-day').textContent = `‚Çπ${bestDay.toFixed(2)}`;
        document.getElementById('avg-daily').textContent = `‚Çπ${avgDaily.toFixed(2)}`;
        
        // Load chart with the data
        loadDailyChart(data);
        
    } catch (error) {
        console.error('Error loading daily data:', error);
    } finally {
        hideLoading();
    }
}

// Load weekly data
async function loadWeeklyData() {
    showLoading();
    try {
        const response = await fetch('/api/analytics/weekly');
        const data = await response.json();
        loadWeeklyChart(data);
    } catch (error) {
        console.error('Error loading weekly data:', error);
    } finally {
        hideLoading();
    }
}

// Load monthly data
async function loadMonthlyData() {
    showLoading();
    try {
        const response = await fetch('/api/analytics/monthly');
        const data = await response.json();
        loadMonthlyChart(data);
    } catch (error) {
        console.error('Error loading monthly data:', error);
    } finally {
        hideLoading();
    }
}

// Load popular items data
async function loadPopularData() {
    showLoading();
    try {
        const response = await fetch('/api/analytics/popular');
        const data = await response.json();
        loadPopularItemsChart(data);
        updatePopularItemsList(data.items);
    } catch (error) {
        console.error('Error loading popular data:', error);
    } finally {
        hideLoading();
    }
}

// Chart loading functions
function loadRevenueChart(data) {
    const ctx = document.getElementById('revenueChart').getContext('2d');
    if (charts.revenue) charts.revenue.destroy();
    
    charts.revenue = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Revenue',
                data: data.values,
                borderColor: '#4a90e2',
                backgroundColor: 'rgba(74, 144, 226, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function loadCategoryChart(data) {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    if (charts.category) charts.category.destroy();
    
    charts.category = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: ['#4a90e2', '#50c878', '#ffa500', '#ff6b6b']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

function loadDailyChart(data) {
    const ctx = document.getElementById('dailyChart').getContext('2d');
    if (charts.daily) charts.daily.destroy();
    
    charts.daily = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Daily Revenue',
                data: data.revenue,
                backgroundColor: 'rgba(74, 144, 226, 0.8)',
                borderColor: '#4a90e2',
                borderWidth: 1
            }, {
                label: 'Daily Orders',
                data: data.orders,
                type: 'line',
                borderColor: '#50c878',
                backgroundColor: 'rgba(80, 200, 120, 0.1)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}

function loadWeeklyChart(data) {
    const ctx = document.getElementById('weeklyChart').getContext('2d');
    if (charts.weekly) charts.weekly.destroy();
    
    charts.weekly = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Weekly Revenue (‚Çπ)',
                data: data.revenue,
                borderColor: '#4a90e2',
                backgroundColor: 'rgba(74, 144, 226, 0.1)',
                tension: 0.4,
                fill: true,
                yAxisID: 'y'
            }, {
                label: 'Weekly Orders',
                data: data.orders,
                borderColor: '#50c878',
                backgroundColor: 'rgba(80, 200, 120, 0.1)',
                tension: 0.4,
                fill: false,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Revenue (‚Çπ)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    grid: { drawOnChartArea: false },
                    title: {
                        display: true,
                        text: 'Orders'
                    }
                }
            }
        }
    });
}

function loadMonthlyChart(data) {
    const ctx = document.getElementById('monthlyChart').getContext('2d');
    if (charts.monthly) charts.monthly.destroy();
    
    charts.monthly = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Monthly Revenue (‚Çπ)',
                data: data.revenue,
                backgroundColor: 'rgba(74, 144, 226, 0.8)',
                borderColor: '#4a90e2',
                borderWidth: 1,
                yAxisID: 'y'
            }, {
                label: 'Monthly Orders',
                data: data.orders,
                type: 'line',
                borderColor: '#50c878',
                backgroundColor: 'rgba(80, 200, 120, 0.1)',
                yAxisID: 'y1',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Revenue (‚Çπ)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    grid: { drawOnChartArea: false },
                    title: {
                        display: true,
                        text: 'Orders'
                    }
                }
            }
        }
    });
}

function loadPopularItemsChart(data) {
    const ctx = document.getElementById('popularItemsChart').getContext('2d');
    if (charts.popular) charts.popular.destroy();
    
    charts.popular = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.items.labels,
            datasets: [{
                label: 'Orders',
                data: data.items.data,
                backgroundColor: [
                    '#4a90e2', '#50c878', '#ffa500', '#ff6b6b', '#9b59b6',
                    '#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9c88ff'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Orders'
                    }
                }
            }
        }
    });
}

function updatePopularItemsList(items) {
    const container = document.getElementById('popular-items-list');
    if (!container) return;
    
    // Create list items from the API data format
    const itemsHTML = items.labels.slice(0, 15).map((itemName, index) => {
        const count = items.data[index];
        return `
            <div class="popular-item">
                <span class="item-rank">#${index + 1}</span>
                <span class="item-name">${itemName}</span>
                <span class="item-count">${count} orders</span>
            </div>
        `;
    }).join('');
    
    container.innerHTML = itemsHTML;
}

// Utility functions
function showLoading() {
    document.getElementById('loading-overlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}

function refreshData() {
    const activeSection = document.querySelector('.analytics-section.active').id.replace('-section', '');
    switchView(activeSection);
}

function initializeAnimations() {
    // Add intersection observer for animations
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
            }
        });
    });
    
    document.querySelectorAll('.fade-in-up').forEach(el => {
        observer.observe(el);
    });
}
</script>
{% endblock %}
